class t{tocItems=[];observer=null;minDepth=10;maxLevel;scrollTimeout=null;contentId;indicatorId;scrollOffset;constructor(t){this.contentId=t.contentId,this.indicatorId=t.indicatorId,this.maxLevel=t.maxLevel||3,this.scrollOffset=t.scrollOffset||80}getContentContainer(){return document.querySelector(".custom-md")||document.querySelector(".prose")||document.querySelector(".markdown-content")}getAllHeadings(){const t=this.getContentContainer();return t?Array.from(t.querySelectorAll("h1, h2, h3, h4, h5, h6")):[]}calculateMinDepth(t){let e=10;return t.forEach(t=>{const n=Number.parseInt(t.tagName.charAt(1),10);e=Math.min(e,n)}),e}filterHeadings(t){return Array.from(t).filter(t=>Number.parseInt(t.tagName.charAt(1),10)<this.minDepth+this.maxLevel)}getCleanTextContent(t){const e=t.cloneNode(!0);for(const n of e.querySelectorAll("script, style"))n.remove();return e.textContent||""}generateBadgeContent(t,e){return t===this.minDepth?e.toString():t===this.minDepth+1?'<div class="transition w-2 h-2 rounded-[0.1875rem] bg-(--toc-badge-bg)"></div>':'<div class="transition w-1.5 h-1.5 rounded-xs bg-black/5 dark:bg-white/10"></div>'}generateTOCHTML(){const t=this.getAllHeadings();if(0===t.length)return'<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p>当前页面没有目录</p></div>';this.minDepth=this.calculateMinDepth(t);const e=this.filterHeadings(t);if(0===e.length)return'<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p>当前页面没有目录</p></div>';let n="",i=1;return e.forEach(t=>{const e=Number.parseInt(t.tagName.charAt(1),10),o=e===this.minDepth?"":e===this.minDepth+1?"pl-4":"pl-8";if(!t.id)return;const s=this.generateBadgeContent(e,i);e===this.minDepth&&i++;let r=this.getCleanTextContent(t).replace(/#+\s*$/,"").trim();if(!r){const e=t.getAttribute("data-subtitles");if(e)try{const t=JSON.parse(e);r=Array.isArray(t)?t[0]:t}catch{}}r||(r="banner-subtitle"===t.id?"Banner Subtitle":t.id||"Heading"),n+=`\n        <a \n          href="#${t.id}" \n          class="px-2 flex gap-2 relative transition w-full min-h-9 rounded-xl hover:bg-(--toc-btn-hover) active:bg-(--toc-btn-active) py-2 ${o}"\n          data-heading-id="${t.id}"\n          aria-label="${r}"\n        >\n          <div class="transition w-5 h-5 shrink-0 rounded-lg text-xs flex items-center justify-center font-bold ${e===this.minDepth?"bg-(--toc-badge-bg) text-(--btn-content)":""}">\n            ${s}\n          </div>\n          <div class="transition text-sm ${e<=this.minDepth+1?"text-50":"text-30"} flex-1 min-w-0 overflow-hidden text-ellipsis whitespace-nowrap">${r}</div>\n        </a>\n      `}),n+=`<div id="${this.indicatorId}" style="opacity: 0;" class="-z-10 absolute bg-(--toc-btn-hover) left-0 right-0 rounded-xl transition-all"></div>`,n}updateTOCContent(){const t=document.getElementById(this.contentId);t&&(t.innerHTML=this.generateTOCHTML(),this.tocItems=Array.from(document.querySelectorAll(`#${this.contentId} a`)))}getVisibleHeadingIds(){const t=this.getAllHeadings(),e=[];if(t.forEach(t=>{if(t.id){const n=t.getBoundingClientRect();n.top<window.innerHeight&&n.bottom>0&&e.push(t.id)}}),0===e.length&&t.length>0){let n=null,i=Number.POSITIVE_INFINITY;t.forEach(t=>{if(t.id){const e=t.getBoundingClientRect(),o=Math.abs(e.top);o<i&&(i=o,n=t.id)}}),n&&e.push(n)}return e}updateActiveState(){if(!this.tocItems||0===this.tocItems.length)return;this.tocItems.forEach(t=>{t.classList.remove("visible")});const t=this.getVisibleHeadingIds(),e=this.tocItems.filter(e=>{const n=e.dataset.headingId;return n&&t.includes(n)});e.forEach(t=>{t.classList.add("visible")}),this.updateActiveIndicator(e)}updateActiveIndicator(t){const e=document.getElementById(this.indicatorId);if(!e||!this.tocItems.length)return;if(0===t.length)return void(e.style.opacity="0");const n=document.getElementById(this.contentId);if(!n)return;const i=n.getBoundingClientRect(),o=t[0],s=t[t.length-1],r=o.getBoundingClientRect(),c=s.getBoundingClientRect(),l=r.top-i.top,a=c.bottom-r.top;e.style.top=`${l}px`,e.style.height=`${a}px`,e.style.opacity="1",o&&this.scrollToActiveItem(o)}scrollToActiveItem(t){if(!t)return;const e=document.querySelector(`#${this.contentId}`)?.closest(".toc-scroll-container");e&&(this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=window.setTimeout(()=>{const n=e.getBoundingClientRect(),i=t.getBoundingClientRect();if(!(i.top>=n.top&&i.bottom<=n.bottom)){const n=t.offsetTop-e.clientHeight/2+t.clientHeight/2;e.scrollTo({top:n,behavior:"smooth"})}},100))}handleClick(t){t.preventDefault();const e=t.currentTarget,n=decodeURIComponent(e.getAttribute("href")?.substring(1)||""),i=document.getElementById(n);if(i){const t=i.getBoundingClientRect().top+window.pageYOffset-this.scrollOffset;window.scrollTo({top:t,behavior:"smooth"})}}setupObserver(){const t=this.getAllHeadings();this.observer&&this.observer.disconnect(),this.observer=new IntersectionObserver(()=>{this.updateActiveState()},{rootMargin:"0px 0px 0px 0px",threshold:0}),t.forEach(t=>{t.id&&this.observer?.observe(t)})}bindClickEvents(){this.tocItems.forEach(t=>{t.addEventListener("click",this.handleClick.bind(this))})}cleanup(){this.observer&&(this.observer.disconnect(),this.observer=null),this.scrollTimeout&&(clearTimeout(this.scrollTimeout),this.scrollTimeout=null)}init(){this.updateTOCContent(),this.bindClickEvents(),this.setupObserver(),this.updateActiveState()}}function e(){return window.location.pathname.includes("/posts/")}export{t as T,e as i};
